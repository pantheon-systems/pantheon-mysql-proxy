#!/bin/bash

# Authenticate with Terminus and pull down drush aliases
echo "Authenticating to Pantheon"
terminus auth login ${PANTHEON_EMAIL} --password=${PANTHEON_PASS} --verbose

# Return MySQL connection info from Pantheon via Terminus.
echo "Returning MySQL credentials from Pantheon."
MYSQL_STRING=$(terminus site connection-info --site=${PANTHEON_SITE} --env=${PANTHEON_ENV} --field=mysql_url);

if [[ "$MYSQL_STRING" =~ mysql:\/\/([^[:space:]]*):([^[:space:]]*)@([^[:space:]]*):([0-9]*)\/([^[:space:]]*) ]]; then
  echo "Extracting MySQL credentials"
  export PANTHEON_DB_UN=${BASH_REMATCH[1]}
  export PANTHEON_DB_PW=${BASH_REMATCH[2]}
  export PANTHEON_DB_HOST=${BASH_REMATCH[3]}
  export PANTHEON_DB_PORT=${BASH_REMATCH[4]}
fi

echo "Starting MySQL proxy"
mysql-proxy --keepalive --log-level=critical --proxy-address=0.0.0.0:${PROXY_DB_PORT} --proxy-backend-addresses=${PANTHEON_DB_HOST}:${PANTHEON_DB_PORT} --proxy-lua-script=/opt/auth.lua --plugins=proxy
